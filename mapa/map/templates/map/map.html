<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Project Map</title>

    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.1.0/dist/maplibre-gl.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>

</head>



<body>

    <!---------------------------- SIDE BAR STYLE --------------------------------------->
    <style>
        .rounded-rect {
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 50px -25px black;
        }
    
        .flex-center {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    
        .flex-center.left {
            left: 0px;
        }
    
        .flex-center.right {
            right: 0px;
        }
    
        .sidebar-content {
            position: absolute;
            width: 95%;
            height: 95%;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 32px;
            color: gray;
        }
    
        .sidebar-toggle {
            position: absolute;
            width: 1.3em;
            height: 1.3em;
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    
        .sidebar-toggle.left {
            right: -1.5em;
        }
        
        .sidebar-toggle:hover {
            color: #0aa1cf;
            cursor: pointer;
        }
    
        .sidebar {
            transition: transform 1s;
            z-index: 1;
            width: 300px;
            height: 100%;
        }
    
        /*
      The sidebar styling has them "expanded" by default, we use CSS transforms to push them offscreen
      The toggleSidebar() function removes this class from the element in order to expand it.
    */
        .left.collapsed {
            transform: translateX(-295px);
        }
    
        .right.collapsed {
            transform: translateX(295px);
        }
    </style>
    
    <!---------------------------------- Body Code ---------------------------------------->

    <script src="https://www.unpkg.com/turf@3.0.14/turf.min.js"></script>
    <script src="https://www.unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link
        rel="stylesheet"
        href="https://www.unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css"
        type="text/css"
    />


    


    <div id="map">
        <div id="left" class="sidebar flex-center left collapsed">
            <div class="sidebar-content rounded-rect flex-center">
                <div>
                    <input type="text" id="nome">
                </div>

                <div
                    class="sidebar-toggle rounded-rect left"
                    onclick="toggleSidebar('left')"
                >
                    &rarr;
                </div>
            </div>
        </div>
    </div>


    <script>

        // ----------------------- Inicio do Script ------------------------------------
        
        let polygonData = null
        var nome = document.getElementById('nome')

        MapboxDraw.constants.classes.CONTROL_BASE  = 'maplibregl-ctrl';
        MapboxDraw.constants.classes.CONTROL_PREFIX = 'maplibregl-ctrl-';
        MapboxDraw.constants.classes.CONTROL_GROUP = 'maplibregl-ctrl-group'

        // ------------------------ Criação do Mapa -------------------------------------

        const map = new maplibregl.Map({
            container: 'map', // container id
            style:
                'https://api.maptiler.com/maps/hybrid/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL', //hosted style id

            zoom: 2 // starting zoom
        });

        map.on('load', () => {
            toggleSidebar('left');

            map.addLayer({
                'id': 'map-layer',
                'type': 'fill',
                'source': {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                },
                'paint': {
                    // Estilo da camada
                    'fill-color': '#ffffff',
                    'fill-opacity': 0.5
                }
            });
        });
        
        // ----------------------- Criando Mapbox ------------------------------------

        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            }
        });
        map.addControl(draw);

        // ----------------------- Criando a area -------------------------------------


        map.on('draw.create', function(e) {
            // sourceMapa.push(mapData)
            console.log(e.features[0])
            var data = e.features[0]

            map.addSource(e.features[0].id, {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': [
                        data
                    ]
                }
            })

        });

        map.on('draw.update', function(e) {
            var data = e.features[0]

            data.properties['nome'] = nome.value;
            data.properties['valor1'] = nome.value + 'valor 1';

            polygonData = data
            
            map.setPaintProperty('map-layer', 'fill-color', {
                    type: 'identity',
                    property: 'name'
            },
                
            );
              

     // ----------------------- AJAX ---------------------------------------

            console.log(polygonData)
            
            fetch('http://127.0.0.1:8000/save_point/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(polygonData)
            }).then(async function(response) {
                if (await response.ok) {
                    console.log('Ponto salvo com sucesso!');
                
                    console.log(response);
                    return response.json()
                } else {
                    console.error('Erro ao salvar ponto!');
                }
            }).catch(error => {
                console.error('Erro ao enviar requisição:', error);
            });
        });

        // ------------------------ ON CLICK FEATURES -------------------------------------


        map.on('draw.selectionchange', function(e){
            polygonData = e.features[0]

            console.log(polygonData)
        })
        


        // ------------------------ Função da SIDE BAR ------------------------------------

        function toggleSidebar(id) {
        const elem = document.getElementById(id);
        const classes = elem.className.split(' ');
        const collapsed = classes.indexOf('collapsed') !== -1;

        const padding = {};

        if (collapsed) {
            // Remove the 'collapsed' class from the class list of the element, this sets it back to the expanded state.
            classes.splice(classes.indexOf('collapsed'), 1);

            padding[id] = 300; // In px, matches the width of the sidebars set in .sidebar CSS class
            map.easeTo({
                padding,
                duration: 1000 // In ms, CSS transition duration property for the sidebar matches this value
            });
        } else {
            padding[id] = 0;
            // Add the 'collapsed' class to the class list of the element
            classes.push('collapsed');

            map.easeTo({
                padding,
                duration: 1000
            });
        }

        // Update the class list on the element
            elem.className = classes.join(' ');
        }
        

    </script>

    
</body>
</html>